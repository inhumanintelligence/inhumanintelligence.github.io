function applyPresence(data) {
  const user = data.discord_user;

  // === USERNAME SYNC ===
  if (user) {
    const displayName = user.global_name || user.username;

    let handle;
    if (user.discriminator && user.discriminator !== "0") {
      handle = `${user.username}#${user.discriminator}`;
    } else {
      handle = user.username;
    }

    document.querySelector("h1").textContent = displayName;
    document.querySelector(".handle").textContent = `@${handle}`;
  }

  const status = data.discord_status || 'offline';
  avatarBadge.className     = 'avatar-badge ' + status;
  statusIndicator.className = 'status-indicator ' + status;
  statusLabel.textContent   = STATUS_LABELS[status] || status;

  const cs = (data.activities || []).find(a => a.type === 4);
  if (cs && (cs.state || cs.emoji?.name)) {
    customStatus.textContent =
      (cs.emoji?.name ? cs.emoji.name + ' ' : '') + (cs.state || '');
    customStatus.style.display = 'block';
  } else {
    customStatus.style.display = 'none';
  }

  const spotify = data.spotify;
  if (status !== 'offline' && spotify) {
    trackName.textContent   = spotify.song    || '—';
    trackArtist.textContent = spotify.artist  || '—';
    trackAlbum.textContent  = spotify.album   || '—';
    nowPlaying.classList.add('visible');

    if (spotify.timestamps?.start && spotify.timestamps?.end) {
      startProgress(spotify.timestamps.start, spotify.timestamps.end);
    } else {
      stopProgress();
    }
  } else {
    nowPlaying.classList.remove('visible');
    stopProgress();
  }
}
